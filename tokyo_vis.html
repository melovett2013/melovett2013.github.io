<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script>
    
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.css' rel='stylesheet' />
    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.8/mapbox.js'></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script type="text/javascript" src="libs/raphael.js"></script>
    
    <link href='http://fonts.googleapis.com/css?family=Raleway|Poiret+One' rel='stylesheet' type='text/css'>
    
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <style type="text/css">
      html, body {
        width: 100%;
        height: 100%;
        background-size: cover;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body class = "viscontainer"> 
    <div class = "header">
      Tokyo Wards Visualization
    </div>
     <div id = "catagories">
      <label><input type="radio" name="filter" value="population" checked> Population </label>
      <label><input type="radio" name="filter" value="density"> Population Density </label>
      <label><input type="radio" name="filter" value="commuters"> % Commuters to other Municipalities </label>  
      <label><input type="radio" name="filter" value="accident"> Traffic Accidents per 100,000 Persons</label>    
      <label><input type="radio" name="filter" value="income"> Taxable Income per Tax Debtor </label>  
    </div> 
    <div id="slider"></div>
    <div id = "play">
      <input type="button" name="animate" value="Play"> 
    </div>
    <div id="map"></div>
    <div id="scale"></div>
    <script type="text/javascript">
      var currenttime;
      var ward_polygons_data;
      var ward_population_data;
      var ward_commuter_data;
      var ward_density_data;
      var ward_accident_data;
      var ward_income_data;
      
      queue()
        .defer(d3.json, "data/wards.geo.json")
        .defer(d3.csv, "data/wards_total_population.csv")
        .defer(d3.csv, "data/ward_population_density.csv")
        .defer(d3.csv, "data/wards_commuters.csv")
        .defer(d3.csv, "data/wards_traffic_accidents.csv")
        .defer(d3.csv, "data/wards_income.csv")
        .await(function(error, polygons, population, density, commuters, accidents, income) { 
        if (!error) {
          ward_polygons_data = polygons;
          ward_population_data = population;
          ward_density_data = density;
          ward_commuter_data = commuters;
          ward_accident_data = accidents;
          ward_income_data = income;
          data_loaded();
        } else {
          console.log("error");
        }});

      function data_loaded() {
        // Set the radio button functionalities
        d3.select("input[value=\"population\"]").on("click", update_view_population);
        d3.select("input[value=\"density\"]").on("click", update_view_density);
        d3.select("input[value=\"commuters\"]").on("click", update_view_commuters);
        d3.select("input[value=\"accident\"]").on("click", update_view_accidents);
        d3.select("input[value=\"income\"]").on("click", update_view_income);

        // Build the map
        L.mapbox.accessToken = 'pk.eyJ1IjoiY2l0eWN5Y2xlIiwiYSI6IjZ3MXNtRW8ifQ.lmAxO5RTphn4Jo-QV63Vpg';
        var layer = L.mapbox.tileLayer('citycycle.lnkh0jpk');
        var map = L.map('map')
          .addLayer(layer)
          .setView([35.669, 139.75], 11);
        var svg = d3.select(map.getPanes().overlayPane).append("svg");
        var g = svg.append("g").attr("class", "leaflet-zoom-hide");
        var polygons_by_name = {};

        // Place wards on screen
        ward_polygons_data.map(function(poly,i) {
          var polygon;
          if(poly.geometry.type=='MultiPolygon') {
            polygon = L.multiPolygon(poly.geometry.coordinates.map(function(d){return mapPolygon(d)}), 
              {color: "white", weight:"2px"}).addTo(map);
          } else if(poly.geometry.type=='Polygon') {
            polygon = L.polygon(mapPolygon(poly.geometry.coordinates), {color: "white", weight:"2px"}).addTo(map);
          }

          polygon.bindPopup("<p><center><b><font size=2>"+ poly.properties.name +"</font></b><br>" + poly.properties.img + "<br>"+ poly.properties.description +"</center></p>");
          polygons_by_name[poly.properties.name] = polygon;
        });
        
        // Create the slider
        var interrupt = false;
        currenttime = 1980;
        $("#slider").slider({
            min: 1980,
            max: 2010,
            value: currenttime,
            step: 5
        }).each(function() {
          var max = $(this).slider('option', 'max');
          var min = $(this).slider('option', 'min');
          var vals = max - min;
          
          // Space out values
          for (var i = 0; i <= vals; i+=5) {
            var el = $('<label>'+(min+i)+'</label>').css('left',(i/vals*100)+'%');
            $( "#slider" ).append(el);
          }
        });

        // Start with population selected
        update_view_population();

        function update_view_population () {
          interrupt = true;
          colorPopulationYear(currenttime);
          $("#slider").slider({
              slide: function(a, b) {
                currenttime = b.value;
                console.log("slide: " + currenttime);
                colorPopulationYear(currenttime);
              }
          });
          document.getElementById("scale").innerHTML = "<img src=img/population_scale.jpg width=70>";
          d3.selectAll("input[name=\"animate\"]").on("click", function () {
            interrupt = false;
            currenttime = 1980;
            population_animation();
          });
        }

        function update_view_density () {
          interrupt = true;
          colorDensityYear(currenttime);
          $("#slider").slider({
              slide: function(a, b) {
                currenttime = b.value;
                console.log("slide: " + currenttime);
                colorDensityYear(currenttime);
              }
          });
          document.getElementById("scale").innerHTML = "<img src=img/density_scale.jpg width=70>";
          d3.selectAll("input[name=\"animate\"]").on("click", function () {
            interrupt = false;
            currenttime = 1985;
            density_animation();
          });
        }

        function update_view_commuters () {
          interrupt = true;
          colorCommuterYear(currenttime);
          $("#slider").slider({
              slide: function(a, b) {
                currenttime = b.value;
                console.log("slide: " + currenttime);
                colorCommuterYear(currenttime);
              }
          });
          document.getElementById("scale").innerHTML = "<img src=img/commuter_scale.jpg width=70>";
          d3.selectAll("input[name=\"animate\"]").on("click", function () {
            interrupt = false;
            currenttime = 1980;
            commuter_animation();
          });
        }

        function update_view_accidents () {
          interrupt = true;
          colorAccidentYear(currenttime);
          $("#slider").slider({
              slide: function(a, b) {
                currenttime = b.value;
                console.log("slide: " + currenttime);
                colorAccidentYear(currenttime);
              }
          });
          document.getElementById("scale").innerHTML = "<img src=img/accident_scale.jpg width=70>";
          d3.selectAll("input[name=\"animate\"]").on("click", function () {
            interrupt = false;
            currenttime = 1980;
            accident_animation();
          });
        }

        function update_view_income () {
          interrupt = true;
          colorIncomeYear(currenttime);
          $("#slider").slider({
              slide: function(a, b) {
                currenttime = b.value;
                console.log("slide: " + currenttime);
                colorIncomeYear(currenttime);
              }
          });
          document.getElementById("scale").innerHTML = "<img src=img/income_scale.jpg width=70>";
          d3.selectAll("input[name=\"animate\"]").on("click", function () {
            interrupt = false;
            currenttime = 1985;
            income_animation();
          });
        }

        function mapPolygon(poly) {
          return poly.map(function(line){return mapLineString(line)})
        }
        function mapLineString(line) {
          return line.map(function(d){return [d[1],d[0]]})  
        }

        function colorPopulationYear(year) {
          if([1980, 1985, 1990, 1995, 2000, 2005, 2010].indexOf(currenttime) == -1) colorNoYear();
          else {
            ward_population_data.forEach(function(i,d) {
            poly = polygons_by_name[i["Region"]];
              if(poly._layers != null) {
                for (var key in poly._layers) {
                  if (poly._layers.hasOwnProperty(key)) colorPolygonPopulationYear(poly._layers[key], i, year);
                }
              } else colorPolygonPopulationYear(poly, i, year);
            });
          }
        }

        function colorDensityYear(year) {
          if([1985, 1990, 1995, 2000, 2005, 2010].indexOf(currenttime) == -1) colorNoYear();
          else {
            ward_density_data.forEach(function(i,d) {
              poly = polygons_by_name[i["Region"]];
              if(poly._layers != null) {
                for (var key in poly._layers) {
                  if (poly._layers.hasOwnProperty(key)) colorPolygonDensityYear(poly._layers[key], i, year);
                }
              } else colorPolygonDensityYear(poly, i, year);
            });
          }
        }

        function colorCommuterYear(year) {
          if([1980, 1985, 1990, 1995, 2000, 2005, 2010].indexOf(currenttime) == -1) colorNoYear();
          else {
            ward_commuter_data.forEach(function(i,d) {
              poly = polygons_by_name[i["Region"]];
              if(poly._layers != null) {
                for (var key in poly._layers) {
                  if (poly._layers.hasOwnProperty(key)) colorPolygonCommuterYear(poly._layers[key], i, year);
                }
              } else colorPolygonCommuterYear(poly, i, year);
            });
          }
        }

        function colorAccidentYear(year) {
          if([1980, 1985, 1990, 1995, 2000, 2005].indexOf(currenttime) == -1) colorNoYear();
          else {
            ward_accident_data.forEach(function(i,d) {
              poly = polygons_by_name[i["Region"]];
              if(poly._layers != null) {
                for (var key in poly._layers) {
                  if (poly._layers.hasOwnProperty(key)) colorPolygonAccidentYear(poly._layers[key], i, year);
                }
              } else colorPolygonAccidentYear(poly, i, year);
            });
          }
        }

        function colorIncomeYear(year) {
          if([1985, 1990, 1995, 2000, 2005, 2010].indexOf(currenttime) == -1) colorNoYear();
          else {
            ward_income_data.forEach(function(i,d) {
              poly = polygons_by_name[i["Region"]];
              if(poly._layers != null) {
                for (var key in poly._layers) {
                  if (poly._layers.hasOwnProperty(key)) colorPolygonIncomeYear(poly._layers[key], i, year);
                }
              } else colorPolygonIncomeYear(poly, i, year);
            });
          }
        }

        function colorNoYear() {
          ward_population_data.forEach(function(i,d) {
          poly = polygons_by_name[i["Region"]];
          if(poly._layers != null) {
            for (var key in poly._layers) {
              if (poly._layers.hasOwnProperty(key)) colorPolygonNoYear(poly._layers[key]);
            }
          } else colorPolygonNoYear(poly);
          });
        }

        function colorPolygonPopulationYear(e, i, year) {
          d3.select(e._path).transition()
            .duration(400)
            .attr({"fill-opacity":".8", "stroke":"white", "fill":function() {
              var gradient = ["#FFB2B2", "#F2A6A6", "#E69B9B", "#DA9090", "#CE8585", "#C17A7A", "#B56F6F", "#A96464", "#9D5959", "#904D4D", "#844242", "#783737", "#6C2C2C", "#5F2121", "#531616", "#470B0B", "#3B0000"];
              var population = parseFloat(i[year].replace(",",""));
              if(population >= 0 && population < 50000) return gradient[0];
              if(population >= 50000 && population < 100000) return gradient[1];
              if(population >= 100000 && population < 150000) return gradient[2];
              if(population >= 150000 && population < 200000) return gradient[3];
              if(population >= 200000 && population < 250000) return gradient[4];
              if(population >= 250000 && population < 300000) return gradient[5];
              if(population >= 300000 && population < 350000) return gradient[6];
              if(population >= 350000 && population < 400000) return gradient[7];
              if(population >= 400000 && population < 450000) return gradient[8];
              if(population >= 500000 && population < 550000) return gradient[9];
              if(population >= 550000 && population < 600000) return gradient[10];
              if(population >= 600000 && population < 650000) return gradient[11];
              if(population >= 650000 && population < 700000) return gradient[12];
              if(population >= 700000 && population < 750000) return gradient[13];
              if(population >= 750000 && population < 800000) return gradient[14];
              if(population >= 800000 && population < 850000) return gradient[15];
              else return gradient[16];
            }});
        }

        function colorPolygonDensityYear(e, i, year) {
          d3.select(e._path).transition()
            .duration(400)
            .attr({"fill-opacity":".8", "stroke":"white", "fill":function() {
              var gradient = ["#DEB2FF", "#D4A8F4", "#CA9EE9", "#C094DE", "#B68AD3", "#AC80C8", "#A376BD", "#996CB2", "#8F62A7", "#85599D", "#7B4F92", "#714587", "#683B7C", "#5E3171", "#542766", "#4A1D5B", "#401350", "#360945", "#2D003B"];
              var density = parseFloat(i[year].replace(",",""));
              if(density >= 2000 && density < 3000) return gradient[0];
              if(density >= 3000 && density < 4000) return gradient[1];
              if(density >= 4000 && density < 5000) return gradient[2];
              if(density >= 5000 && density < 6000) return gradient[3];
              if(density >= 6000 && density < 7000) return gradient[4];
              if(density >= 7000 && density < 8000) return gradient[5];
              if(density >= 8000 && density < 9000) return gradient[6];
              if(density >= 9000 && density < 10000) return gradient[7];
              if(density >= 10000 && density < 11000) return gradient[8];
              if(density >= 11000 && density < 12000) return gradient[9];
              if(density >= 12000 && density < 13000) return gradient[10];
              if(density >= 13000 && density < 14000) return gradient[11];
              if(density >= 14000 && density < 15000) return gradient[12];
              if(density >= 15000 && density < 16000) return gradient[13];
              if(density >= 16000 && density < 17000) return gradient[14];
              if(density >= 17000 && density < 18000) return gradient[15];
              if(density >= 18000 && density < 19000) return gradient[16];
              if(density >= 19000 && density < 20000) return gradient[17];
              else return gradient[18];
            }});
        }

        function colorPolygonCommuterYear(e, i, year) {
          d3.select(e._path).transition()
            .duration(400)
            .attr({"fill-opacity":".8", "stroke":"white", "fill":function() {
              var gradient = ["#B2B5FF", "#9EA0E9", "#8A8CD3", "#7678BD", "#6264A7", "#4F5092", "#3B3C7C", "#272866", "#131450", "#00003B"];
              var commuters = parseFloat(i[year].replace(",",""));
              if(commuters >= 20 && commuters < 25) return gradient[0];
              if(commuters >= 25 && commuters < 30) return gradient[1];
              if(commuters >= 30 && commuters < 35) return gradient[2];
              if(commuters >= 35 && commuters < 40) return gradient[3];
              if(commuters >= 40 && commuters < 45) return gradient[4];
              if(commuters >= 45 && commuters < 50) return gradient[5];
              if(commuters >= 50 && commuters < 55) return gradient[6];
              if(commuters >= 55 && commuters < 60) return gradient[7];   
              if(commuters >= 60 && commuters < 65) return gradient[8];
              else return gradient[9];
            }});
        }

        function colorPolygonAccidentYear(e, i, year) {
          d3.select(e._path).transition()
            .duration(400)
            .attr({"fill-opacity":".8", "stroke":"white", "fill":function() {
              var gradient = ["#CAE8E6", "#BEDEDC", "#B3D4D3", "#A8CAC9", "#9DC0C0", "#91B7B6", "#86ADAD", "#7BA3A3", "#70999A", "#659090", "#598687", "#4E7C7D", "#437274", "#38686A", "#2C5F61", "#215557", "#164B4E", "#0B4144", "#00383B"];
              var accidents = parseFloat(i[year].replace(",",""));
              if(accidents >= 0 && accidents < 300) return gradient[0];
              if(accidents >= 300 && accidents < 600) return gradient[1];
              if(accidents >= 600 && accidents < 900) return gradient[2];
              if(accidents >= 900 && accidents < 1200) return gradient[3];
              if(accidents >= 1200 && accidents < 1500) return gradient[4];
              if(accidents >= 1500 && accidents < 1800) return gradient[5];
              if(accidents >= 1800 && accidents < 2100) return gradient[6];
              if(accidents >= 2100 && accidents < 2400) return gradient[7];
              if(accidents >= 2400 && accidents < 2700) return gradient[8];
              if(accidents >= 2700 && accidents < 3300) return gradient[9];
              if(accidents >= 3300 && accidents < 3600) return gradient[10];
              if(accidents >= 3600 && accidents < 3900) return gradient[11];
              if(accidents >= 3900 && accidents < 4200) return gradient[12];
              if(accidents >= 4200 && accidents < 4500) return gradient[13];
              if(accidents >= 4500 && accidents < 4800) return gradient[14];
              if(accidents >= 4800 && accidents < 5100) return gradient[15];
              if(accidents >= 5100 && accidents < 5400) return gradient[16];
              if(accidents >= 5400 && accidents < 5700) return gradient[17];
              else return gradient[18];
            }});
        }

        function colorPolygonIncomeYear(e, i, year) {
          d3.select(e._path).transition()
            .duration(400)
            .attr({"fill-opacity":".8", "stroke":"white", "fill":function() {
              var gradient = ["#CAE6CC", "#ADCDAF", "#90B593", "#739C76", "#56845A", "#396B3D", "#1C5321", "#003B05"];
              var income = parseFloat(i[year].replace(",",""));
              if(income >= 2000 && income < 3000) return gradient[0];
              if(income >= 3000 && income < 4000) return gradient[1];
              if(income >= 4000 && income < 5000) return gradient[2];
              if(income >= 5000 && income < 6000) return gradient[3];
              if(income >= 6000 && income < 7000) return gradient[4];
              if(income >= 7000 && income < 8000) return gradient[5];
              if(income >= 8000 && income < 9000) return gradient[6];
              else return gradient[7];
            }});
        }

        function colorPolygonNoYear(e) {
           d3.select(e._path).transition()
            .duration(400)
            .attr({"fill-opacity":".8", "stroke":"white", "fill":"#D3D3D3"});
        }

        function population_animation() {
          $("#slider").slider('value', currenttime);
          colorPopulationYear(currenttime);
          myVar = setTimeout(function () {
            if(currenttime < 2010 && interrupt == false) {
              currenttime += 5;
              population_animation();
            }
          }, 400)
        }

        function density_animation() {
          $("#slider").slider('value', currenttime);
          colorDensityYear(currenttime);
          myVar = setTimeout(function () {
            if(currenttime < 2010 && interrupt == false) {
              currenttime += 5;
              density_animation();
            }
          }, 400)
        }

        function commuter_animation() {
          $("#slider").slider('value', currenttime);
          colorCommuterYear(currenttime);
          myVar = setTimeout(function () {
            if(currenttime < 2010 && interrupt == false) {
              currenttime += 5;
              commuter_animation();
            }
          }, 400)
        }

        function accident_animation() {
          $("#slider").slider('value', currenttime);
          colorAccidentYear(currenttime);
          myVar = setTimeout(function () {
            if(currenttime < 2005 && interrupt == false) {
              currenttime += 5;
              accident_animation();
            }
          }, 400)
        }

        function income_animation() {
          $("#slider").slider('value', currenttime);
          colorIncomeYear(currenttime);
          myVar = setTimeout(function () {
            if(currenttime < 2010 && interrupt == false) {
              currenttime += 5;
              income_animation();
            }
          }, 400)
        }
      } 
    </script>
  </body>
</html>